openapi: 3.0.3
info:
  title: ご近所サポートちょこっと API設計書
  version: 1.0.0
  description: |
    高齢者 × ボランティア マッチングアプリ「ちょこっと」のAPI仕様書です。  
    各エンドポイントの概要・入力・出力・ステータスコードを示します。
servers:
  - url: http://localhost:3001/api
    description: 開発環境

tags:
  - name: Auth
    description: Firebase 認証・QRログイン関連
  - name: GPT Proxy
    description: OpenAI による自然文解析
  - name: Normalize Time
    description: 時間表現の正規化
  - name: Orders
    description: 引受・ステータス更新・履歴取得
  - name: User
    description: 利用者（高齢者）向けAPI
  - name: Supporter
    description: サポーター（ボランティア）向けAPI

paths:
  /auth/qr-login:
    post:
      tags:
        - Auth
      summary: QRコードログイン
      description: |
        QRコードで生成された一時トークンを検証し、対応するFirebase UIDのCustom Tokenを発行します。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token:
                  type: string
                  example: "abcd1234efgh5678"
      responses:
        "200":
          description: 成功時にFirebase Custom Tokenを返します。
          content:
            application/json:
              schema:
                type: object
                properties:
                  customToken:
                    type: string
                    example: "eyJhbGciOiJSUzI1NiIsImtpZCI6IjJh..."
        "400":
          description: Tokenが指定されていない
        "401":
          description: 無効または期限切れのトークン
        "500":
          description: サーバーエラー

  /gpt-proxy:
    post:
      tags:
        - GPT Proxy
      summary: 自然文から日付・時間・場所などを抽出する
      description: |
        ユーザーの自然文をOpenAI APIで解析し、「日時」「時間」「場所」「その他」をJSON形式で返します。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [text]
              properties:
                text:
                  type: string
                  example: "明日の午後2時に市役所で申請書を出したい"
      responses:
        "200":
          description: 解析結果を返します
          content:
            application/json:
              schema:
                type: object
                properties:
                  date:
                    type: string
                    example: "2025年11月9日"
                  time:
                    type: string
                    example: "午後2時"
                  place:
                    type: string
                    example: "市役所"
                  normalizedTime:
                    type: object
                    example:
                      scheduledStartTime: "14:00"
                      scheduledEndTime: "15:00"
        "400":
          description: text が指定されていない
        "500":
          description: サーバー内部エラー

  /normalize-time:
    post:
      tags:
        - Normalize Time
      summary: 時間表現の正規化
      description: |
        「午前」「午後」「夕方」などの自然文を解析し、時間範囲を正規化します。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [timeText]
              properties:
                timeText:
                  type: string
                  example: "午後"
      responses:
        "200":
          description: 正規化成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  scheduledStartTime:
                    type: string
                    example: "13:00"
                  scheduledEndTime:
                    type: string
                    example: "17:00"
                  normalizedText:
                    type: string
                    example: "13:00から17:00まで"
        "400":
          description: 入力エラー

  /user/requests:
    get:
      tags:
        - User
      summary: 利用者自身が依頼した依頼の一覧を取得
      description: |
        ログイン中の利用者が作成した依頼のうち、  
        status が completed / canceled / expired 以外の依頼を返します。
      security:
        - bearerAuth: []
      responses:
        "200":
          description: 依頼一覧取得成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/UserRequest"
        "403":
          description: 利用者のみ依頼可能です。
        "500":
          description: サーバーエラー

    post:
      tags:
        - User
      summary: 新規依頼を登録
      description: |
        ログイン中の利用者が新しい依頼を登録します。  
        バリデーションは Zod スキーマ `RequestCreateSchema` によって行われます。  
        title は固定で「買い物代行」が設定されます。
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NewRequestInput"
      responses:
        "201":
          description: 新規依頼登録成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NewRequest"
        "400":
          description: Zod バリデーションエラー
        "403":
          description: 利用者のみ依頼可能です。
        "500":
          description: サーバーエラー

  /user/requests/{requestId}:
    get:
      tags:
        - User
      summary: 利用者向けの依頼詳細を取得
      description: |
        ログイン中の利用者が自分の依頼した依頼の詳細を取得します。  
        matchedSupporterId がある場合は、サポーター情報も返します。
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: requestId
          required: true
          schema:
            type: integer
            example: 12
      responses:
        "200":
          description: 依頼詳細取得成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RequestDetailUser"
        "400":
          description: リクエストIDは数値を入力してください。
        "403":
          description: あなたの依頼ではありません。
        "404":
          description: 依頼が見つかりません。
        "500":
          description: サーバーエラー

  /supporter/requests:
    get:
      tags:
        - Supporter
      summary: サポーター向け募集中依頼一覧を取得
      description: |
        ログイン中のサポーター向けに「open」の依頼一覧を返します。  
        ただし、そのサポーターが decline(辞退した） / refusal（交代要請された）依頼は除外されます。
      security:
        - bearerAuth: []
      responses:
        "200":
          description: 依頼一覧取得成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SupporterRequest"
        "403":
          description: サポーターのみ閲覧可能です。
        "500":
          description: サーバーエラー

  /supporter/requests/{requestId}:
    get:
      tags:
        - Supporter
      summary: サポーター向けの依頼詳細を取得
      description: |
        依頼の詳細情報を返します。  
        - 募集中(open)の場合：利用者情報は簡易表示  
        - 自分が引き受けた依頼：利用者の詳細情報を返す  
        - 他のサポーターが引き受けている場合(異常系)：利用者情報は簡易表示
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: requestId
          required: true
          schema:
            type: integer
            example: 12
      responses:
        "200":
          description: 依頼詳細取得成功
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/SupporterRequestDetailOpen"
                  - $ref: "#/components/schemas/SupporterRequestDetailMatched"

              examples:
                openCase:
                  summary: open の場合のuser情報
                  value:
                    id:
                      type: integer
                    title:
                      type: string
                    description:
                      type: string
                    status:
                      type: string
                      enum: [open, matched, confirmed, completed, canceled, expired]
                      example: "open"
                    scheduledDate:
                      type: string
                      format: date
                    scheduledStartTime:
                      type: string
                    scheduledEndTime:
                      type: string
                    scheduledDurationMinutes:
                      type: integer
                      nullable: true
                    workLocation1:
                      type: string
                    workLocation2:
                      type: string
                    matchedSupporterId:
                      type: string
                      nullable: true
                    centerId:
                      type: string
                    createdAt:
                      type: string
                      format: date-time
                    updatedAt:
                      type: string
                      format: date-time
                    user:
                      ageGroup: "80代"
                      gender: "女性"
                      address1: "旭町1丁目"
                      bio: "難聴があり聞き取りにくいので、ゆっくり話してください。"

                matchedCase:
                  summary: matched の場合のuser情報
                  value:
                    id:
                      type: integer
                    title:
                      type: string
                    description:
                      type: string
                    status:
                      type: string
                      enum: [open, matched, confirmed, completed, canceled, expired]
                      example: "open"
                    scheduledDate:
                      type: string
                      format: date
                    scheduledStartTime:
                      type: string
                    scheduledEndTime:
                      type: string
                    scheduledDurationMinutes:
                      type: integer
                      nullable: true
                    workLocation1:
                      type: string
                    workLocation2:
                      type: string
                    matchedSupporterId:
                      type: string
                      nullable: true
                    centerId:
                      type: string
                    createdAt:
                      type: string
                      format: date-time
                    updatedAt:
                      type: string
                      format: date-time
                    user:
                      familyName: "井上"
                      firstName: "節子"
                      familyNameKana: "イノウエ"
                      firstNameKana: "セツコ"
                      gender: "女性"
                      phoneNumber: "090-1111-1111"
                      address1: "旭町1丁目"
                      address2: "42-55"
                      profileImageUrl: "/sampleuser6.png"
                      bio: "難聴があり聞き取りにくいので、ゆっくり話してください。"
                      ageGroup: "80代"
        "400":
          description: リクエストIDは数値を入力してください。
        "403":
          description: |
            閲覧権限なし  
            - サポーターのみ閲覧可能です。 
            - この依頼は他のサポーターが対応中のため閲覧できません。
        "404":
          description: |
            該当データなし
            - 依頼が見つかりません。
            - 利用者情報が見つかりません。
        "500":
          description: サーバーエラー

  /supporter/orders:
    get:
      tags:
        - Supporter
      summary: サポーターが引き受けた依頼一覧を取得
      description: |
        ログイン中のサポーター自身が引き受けた依頼一覧を返します。  
        依頼者情報を含みます。
      security:
        - bearerAuth: []
      responses:
        "200":
          description: 引受一覧取得成功（空の場合は空配列を返します）
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SupporterOrderSummary"
        "403":
          description: サポーターのみ閲覧できます。
        "500":
          description: サーバーエラー

  /supporter/orders/{requestId}:
    post:
      tags:
        - Supporter
      summary: 依頼を引き受ける
      description: |
        指定した requestId の依頼を "matched" に更新し、  
        supporterId を設定した Orderデータを作成します。  
        依頼の status が open の場合のみ引受可能です。
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: requestId
          required: true
          schema:
            type: integer
            example: 101
      responses:
        "201":
          description: 引受登録成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SupporterOrderCreated"
        "400":
          description: この依頼は受付終了です。
        "403":
          description: サポーターのみ引受可能です。
        "404":
          description: 指定された依頼が見つかりません。
        "500":
          description: サーバーエラー

  /orders/{requestId}:
    patch:
      tags:
        - Orders
      summary: 依頼のステータスを更新する
      description: |
        指定された requestId の依頼に対して、status の更新を行います。    
        実行者の role（user / supporter）によって更新できるステータスが異なります。  

        **利用者(user) が更新できるステータス：**  
        - canceled  
        - refusal（サポーター交代要請）

        **サポーター(supporter) が更新できるステータス：**  
        - confirmed（電話連絡済み）  
        - completed  
        - decline（辞退）

        **decline / refusal の場合：**  
        - order.status を decline/refusal に変更  
        - request.status を open に戻す  
        - request.matchedSupporterId を null に戻す
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: requestId
          required: true
          schema:
            type: integer
            example: 101
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [updateStatus]
              properties:
                updateStatus:
                  type: string
                  enum:
                    - confirmed
                    - completed
                    - canceled
                    - decline
                    - refusal
                  example: "confirmed"
      responses:
        "200":
          description: ステータス更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  OrderRequestUpdated:
                    $ref: "#/components/schemas/OrderRequestUpdated"

              examples:
                createdOrder:
                  summary: Ordersの更新
                  value:
                    status: "canceled"
                updatedRequest:
                  summary: Requestの更新
                  value:
                    status: "canceled"

        "400":
          description: |
            バリデーションエラー  
            - リクエストIDは数値を指定してください。  
            - 不正なステータスです。
        "403":
          description: |
            実行権限なし  
            - 依頼者本人のみ操作可能です。  
            - 担当サポーターのみ操作可能です。
        "404":
          description: 指定された依頼が見つかりません。
        "409":
          description: |
            不整合  
            - 引受されていないため、この操作はできません。  
            - 対応する引受データが見つかりません。
        "500":
          description: サーバーエラー

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # =====================================================
    #  ユーザー向け依頼一覧 UserRequest
    # =====================================================
    UserRequest:
      type: object
      properties:
        id:
          type: integer
          example: 123
        title:
          type: string
          example: "買い物代行"
        description:
          type: string
          example: "鼻炎の薬をお願いします"
        status:
          type: string
          enum: [open, matched, confirmed, completed, canceled, expired]
          example: "open"
        scheduledDate:
          type: string
          format: date
          example: "2025-11-10"
        scheduledStartTime:
          type: string
          example: "10:00"
        scheduledEndTime:
          type: string
          example: "11:00"
        scheduledDurationMinutes:
          type: integer
          nullable: true
        workLocation1:
          type: string
          example: "マツモトキヨシ"
        workLocation2:
          type: string
          example: "旭町1丁目"
        matchedSupporterId:
          type: string
          nullable: true
        centerId:
          type: string
          example: "C001"
        createdAt:
          type: string
          format: date-time
          example: "2025-11-01T10:15:30Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-11-01T10:15:30Z"

    # =====================================================
    #  新規依頼(入力) NewRequestInpit
    # =====================================================
    NewRequestInput:
      type: object
      properties:
        description:
          type: string
          example: "鼻炎の薬をお願いします"
        scheduledDate:
          type: string
          format: date
          example: "2025-11-10"
        scheduledStartTime:
          type: string
          example: "10:00"
        scheduledEndTime:
          type: string
          example: "11:00"
        workLocation1:
          type: string
          example: "マツモトキヨシ"

    # =====================================================
    #  新規依頼(出力) NewRequest
    # =====================================================
    NewRequest:
      type: object
      properties:
        title:
          type: string
          example: "買い物代行"
        description:
          type: string
          example: "鼻炎の薬をお願いします"
        scheduledDate:
          type: string
          format: date
          example: "2025-11-10"
        scheduledStartTime:
          type: string
          example: "10:00"
        scheduledEndTime:
          type: string
          example: "11:00"
        workLocation1:
          type: string
          example: "マツモトキヨシ"
        workLocation2:
          type: string
          example: "旭町1丁目"
        cenerId:
          type: string
          example: "C001"

    # =====================================================
    #  利用者向け詳細 RequestDetailUser
    # =====================================================
    RequestDetailUser:
      type: object
      properties:
        id:
          type: integer
          example: 123
        title:
          type: string
          example: "買い物代行"
        description:
          type: string
          example: "鼻炎の薬をお願いします"
        status:
          type: string
          enum: [open, matched, confirmed, completed, canceled, expired]
          example: "matched"
        scheduledDate:
          type: string
          format: date
          example: "2025-11-10"
        scheduledStartTime:
          type: string
          example: "10:00"
        scheduledEndTime:
          type: string
          example: "11:00"
        scheduledDurationMinutes:
          type: integer
          nullable: true
        workLocation1:
          type: string
          example: "マツモトキヨシ"
        workLocation2:
          type: string
          example: "旭町1丁目"
        matchedSupporterId:
          type: string
          example: "BuUmfPzwDpfZi4mtPACvdQrMiE73"
        centerId:
          type: string
          example: "C001"
        createdAt:
          type: string
          format: date-time
          example: "2025-11-01T10:15:30Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-11-01T10:15:30Z"
        supporter:
          type: object
          nullable: true
          description: matchedSupporterId がある場合のみ表示
          properties:
            supporterName:
              type: string
              example: "木下亜里沙"
            supporterPhone:
              type: string
              example: "080-3333-3333"
            supporterNote:
              type: string
              example: "お役に立てると嬉しいです！"
            supporterAvatarUrl:
              type: string
              example: "/sampleuser3.png"

    # =====================================================
    #  サポーター向け募集中依頼一覧 SupporterRequest
    # =====================================================
    SupporterRequest:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
        description:
          type: string
        status:
          type: string
          enum: [open, matched, confirmed, completed, canceled, expired]
          example: "open"
        scheduledDate:
          type: string
          format: date
        scheduledStartTime:
          type: string
        scheduledEndTime:
          type: string
        scheduledDurationMinutes:
          type: integer
          nullable: true
        workLocation1:
          type: string
        workLocation2:
          type: string
        matchedSupporterId:
          type: string
          nullable: true
        centerId:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        user:
          type: object
          properties:
            id:
              type: string
            gender:
              type: string
            address1:
              type: string
            ageGroup:
              type: string
              example: "80代"
            bio:
              type: string

    # =====================================================
    # サポーター向け詳細(引受前) SupporterRequestDetailOpen
    # =====================================================
    SupporterRequestDetailOpen:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
        description:
          type: string
        status:
          type: string
          enum: [open, matched, confirmed, completed, canceled, expired]
          example: "open"
        scheduledDate:
          type: string
          format: date
        scheduledStartTime:
          type: string
        scheduledEndTime:
          type: string
        scheduledDurationMinutes:
          type: integer
          nullable: true
        workLocation1:
          type: string
        workLocation2:
          type: string
        matchedSupporterId:
          type: string
          nullable: true
        centerId:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        user:
          type: object
          properties:
            ageGroup:
              type: string
              example: "80代"
            gender:
              type: string
            address1:
              type: string
            bio:
              type: string

    # =====================================================
    # サポーター向け詳細(引受済) SupporterRequestDetailMatched
    # =====================================================
    SupporterRequestDetailMatched:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
        description:
          type: string
        status:
          type: string
          enum: [open, matched, confirmed, completed, canceled, expired]
          example: "matched"
        scheduledDate:
          type: string
          format: date
        scheduledStartTime:
          type: string
        scheduledEndTime:
          type: string
        scheduledDurationMinutes:
          type: integer
          nullable: true
        workLocation1:
          type: string
        workLocation2:
          type: string
        matchedSupporterId:
          type: string
          nullable: true
        centerId:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        user:
          type: object
          properties:
            familyName:
              type: string
            firstName:
              type: string
            familyNameKana:
              type: string
            firstNameKana:
              type: string
            gender:
              type: string
            phoneNumber:
              type: string
            address1:
              type: string
            address2:
              type: string
            profileImageUrl:
              type: string
            bio:
              type: string
            ageGroup:
              type: string
              example: "80代"

    # =====================================================
    # サポーター向け引受一覧 SupporterOrderSummary
    # =====================================================
    SupporterOrderSummary:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
        description:
          type: string
        status:
          type: string
          enum: [open, matched, confirmed, completed, canceled, expired]
          example: "matched"
        scheduledDate:
          type: string
          format: date
        scheduledStartTime:
          type: string
        scheduledEndTime:
          type: string
        scheduledDurationMinutes:
          type: integer
          nullable: true
        workLocation1:
          type: string
        workLocation2:
          type: string
        matchedSupporterId:
          type: string
          nullable: true
        centerId:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        user:
          type: object
          properties:
            id:
              type: string
            gender:
              type: string
            address1:
              type: string
            ageGroup:
              type: string
              example: "80代"
            bio:
              type: string

    # =====================================================
    # 引受時の返却形式 SupporterOrderCreated
    # =====================================================
    SupporterOrderCreated:
      type: object
      properties:
        message:
          type: string
          example: "Order created successfully"

        updatedRequest:
          type: object
          properties:
            matchedSupporterId:
              type: string
            status:
              type: string
              enum: [open, matched, confirmed, completed, canceled]
              example: "matched"

        createdOrder:
          type: object
          properties:
            requestId:
              type: integer
            supporterId:
              type: string
            status:
              type: string
              enum: [matched, confirmed, completed, canceled, decline, refusal]
              example: "matched"

    # =====================================================
    # ステータス更新時の返却形式 OrderRequestUpdated
    # =====================================================
    OrderRequestUpdated:
      type: object
      properties:
        message:
          type: string
          example: "Status updated successfully"

        updatedOrder:
          type: object
          properties:
            requestId:
              type: integer
            supporterId:
              type: string
            status:
              type: string
              enum: [matched, confirmed, completed, canceled, decline, refusal]
              example: "canceled"

        updatedRequest:
          type: object
          properties:
            matchedSupporterId:
              type: string
            status:
              type: string
              enum: [open, matched, confirmed, completed, canceled]
              example: "canceled"

    # =====================================================
    # ErrorResponse
    # =====================================================
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
