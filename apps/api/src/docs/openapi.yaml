openapi: 3.0.3
info:
  title: ご近所サポートちょこっと API設計書
  version: 1.0.0
  description: >
    高齢者 × サポーター マッチングアプリ「ちょこっと」のAPI仕様書です。  
    各エンドポイントの概要・入力・出力・ステータスコードを示します。
servers:
  - url: http://localhost:3001/api
    description: 開発環境

tags:
  - name: Auth
    description: Firebase 認証・QRログイン関連
  - name: GPT Proxy
    description: OpenAI による自然文解析
  - name: Normalize Time
    description: 時間表現の正規化
  - name: Requests
    description: 依頼情報の取得・登録・詳細表示
  - name: Orders
    description: 受注・ステータス更新・履歴取得

paths:
  /auth/qr-login:
    post:
      tags:
        - Auth
      summary: QRコードログイン
      description: >
        QRコードで生成された一時トークンを検証し、対応するFirebase UIDのCustom Tokenを発行します。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token:
                  type: string
                  example: "abcd1234efgh5678"
      responses:
        "200":
          description: 成功時にFirebase Custom Tokenを返します。
          content:
            application/json:
              schema:
                type: object
                properties:
                  customToken:
                    type: string
                    example: "eyJhbGciOiJSUzI1NiIsImtpZCI6IjJh..."
        "400":
          description: Tokenが指定されていない
        "401":
          description: 無効または期限切れのトークン
        "500":
          description: サーバーエラー

  /gpt-proxy:
    post:
      tags:
        - GPT Proxy
      summary: 自然文から日付・時間・場所などを抽出する
      description: >
        ユーザーの自然文をOpenAI APIで解析し、「日時」「時間」「場所」「その他」をJSON形式で返します。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [text]
              properties:
                text:
                  type: string
                  example: "明日の午後2時に市役所で申請書を出したい"
      responses:
        "200":
          description: 解析結果を返します
          content:
            application/json:
              schema:
                type: object
                properties:
                  date:
                    type: string
                    example: "2025年11月9日"
                  time:
                    type: string
                    example: "午後2時"
                  place:
                    type: string
                    example: "市役所"
                  normalizedTime:
                    type: object
                    example:
                      scheduledStartTime: "14:00"
                      scheduledEndTime: "15:00"
        "400":
          description: text が指定されていない
        "500":
          description: サーバー内部エラー

  /normalize-time:
    post:
      tags:
        - Normalize Time
      summary: 時間表現の正規化
      description: >
        「午前」「午後」「夕方」などの自然文を解析し、時間範囲を正規化します。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [timeText]
              properties:
                timeText:
                  type: string
                  example: "午後"
      responses:
        "200":
          description: 正規化成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  scheduledStartTime:
                    type: string
                    example: "13:00"
                  scheduledEndTime:
                    type: string
                    example: "17:00"
                  normalizedText:
                    type: string
                    example: "13:00から17:00まで"
        "400":
          description: 入力エラー

   /user/requests:
    get:
      tags:
        - User
        - Requests
      summary: 利用者の依頼一覧を取得
      description: >
        ログイン中の利用者が作成した依頼のうち、  
        status が completed / canceled / expired 以外の依頼を返します。
      security:
        - bearerAuth: []
      responses:
        "200":
          description: 依頼一覧取得成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Request"
        "403":
          description: 利用者(role=user) 以外は禁止
        "500":
          description: サーバーエラー

    post:
      tags:
        - User
        - Requests
      summary: 新規依頼を登録
      description: >
        ログイン中の利用者が新しい依頼を登録します。  
        バリデーションは Zod スキーマ `RequestCreateSchema` によって行われます。  
        title は固定で「買い物代行」が設定されます。
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - description
                - scheduledDate
                - scheduledStartTime
                - scheduledEndTime
              properties:
                description:
                  type: string
                  example: "スーパーで牛乳と卵を買ってきてください。"
                scheduledDate:
                  type: string
                  format: date
                  example: "2025-11-10"
                scheduledStartTime:
                  type: string
                  example: "10:00"
                scheduledEndTime:
                  type: string
                  example: "11:00"
                location1:
                  type: string
                  example: "マツモトキヨシ"
      responses:
        "201":
          description: 新規依頼登録成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Request"
        "400":
          description: Zod バリデーションエラー
        "403":
          description: 利用者(role=user) 以外は禁止
        "500":
          description: サーバーエラー

  /user/requests/{requestId}:
    get:
      tags:
        - User
        - Requests
      summary: 依頼詳細を取得（利用者向け）
      description: >
        ログイン中の利用者が自分の依頼の詳細を取得します。  
        matchedSupporterId がある場合は、サポーター情報も返します。
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: requestId
          required: true
          schema:
            type: integer
            example: 12
      responses:
        "200":
          description: 依頼詳細取得成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RequestDetailUser"
        "400":
          description: 無効な requestId
        "403":
          description: 自分の依頼以外は禁止
        "404":
          description: 該当依頼が存在しない
        "500":
          description: サーバーエラー

  /supporter/requests:
    get:
      tags:
        - Supporter
        - Requests
      summary: サポーター向け依頼一覧を取得
      description: >
        ログイン中のサポーターが確認できる「open」の依頼一覧を返します。  
        ただし、そのサポーターが decline/refusal した依頼は除外されます。
      security:
        - bearerAuth: []
      responses:
        "200":
          description: 依頼一覧取得成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SupporterRequest"
        "403":
          description: サポーター(role=supporter) 以外は禁止
        "500":
          description: サーバーエラー

  /supporter/requests/{requestId}:
    get:
      tags:
        - Supporter
        - Requests
      summary: 依頼詳細を取得（サポーター向け）
      description: >
        依頼の詳細情報を返します。  
        - status=open の場合：利用者情報は簡易表示  
        - 自分が matched した依頼：利用者の詳細情報を返す  
        - 他のサポーターが matched：利用者情報は簡易表示
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: requestId
          required: true
          schema:
            type: integer
            example: 12
      responses:
        "200":
          description: 依頼詳細取得成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SupporterRequestDetail"
        "400":
          description: 無効な requestId
        "403":
          description: サポーターのみアクセス可能
        "404":
          description: 該当依頼が存在しない
        "500":
          description: サーバーエラー

  /supporter/orders:
    get:
      tags:
        - Supporter
        - Orders
      summary: サポーターが受注した依頼一覧を取得
      description: >
        ログイン中のサポーター自身が引き受けた依頼一覧を返します。  
        Request と User（依頼者情報）を含みます。
      security:
        - bearerAuth: []
      responses:
        "200":
          description: 引受一覧取得成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SupporterOrderSummary"
        "403":
          description: サポーター以外禁止
        "500":
          description: サーバーエラー

  /supporter/orders/{requestId}:
    post:
      tags:
        - Supporter
        - Orders
      summary: 依頼を受注する
      description: >
        指定した requestId の依頼を "matched" に更新し、  
        supporterId を設定した Order を作成します。  
        依頼の status が open の場合のみ受注可能です。
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: requestId
          required: true
          schema:
            type: integer
            example: 101
      responses:
        "201":
          description: 受注登録成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SupporterOrderCreated"
        "400":
          description: 依頼が open ではない
        "403":
          description: サポーターのみ許可
        "404":
          description: 指定された依頼なし
        "500":
          description: サーバーエラー

  /orders/{requestId}:
    patch:
      tags:
        - Orders
      summary: 依頼のステータスを更新する
      description: >
        指定された requestId の依頼に対して、status の更新を行います。  
        実行者の role（user / supporter）によって更新できるステータスが異なります。  
        
        **利用者(user) が更新できるステータス：**  
        - canceled  
        - refusal（サポーター変更依頼）

        **サポーター(supporter) が更新できるステータス：**  
        - confirmed  
        - completed  
        - decline（辞退）

        **decline / refusal の場合：**  
        - order.status を decline/refusal に変更  
        - request.status を open に戻し  
        - request.matchedSupporterId を null に戻す
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: requestId
          required: true
          schema:
            type: integer
            example: 101
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [updateStatus]
              properties:
                updateStatus:
                  type: string
                  enum:
                    - confirmed
                    - completed
                    - canceled
                    - decline
                    - refusal
                  example: "confirmed"
      responses:
        "200":
          description: ステータス更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  updatedRequest:
                    $ref: "#/components/schemas/Request"
                  updatedOrder:
                    $ref: "#/components/schemas/Order"
        "400":
          description: 不正なステータス・バリデーションエラー
        "403":
          description: 実行権限なし
        "404":
          description: 指定された依頼なし
        "500":
          description: サーバーエラー

components:
  schemas:

    # =====================================================
    #  Request（基本形：利用者/サポーター両方共通）
    # =====================================================
    Request:
      type: object
      properties:
        id:
          type: integer
          example: 123
        title:
          type: string
          example: "買い物代行"
        description:
          type: string
          example: "牛乳と卵をお願いします"
        status:
          type: string
          enum: [open, matched, confirmed, completed, canceled, expired]
          example: "open"
        scheduledDate:
          type: string
          format: date
          example: "2025-11-10"
        scheduledStartTime:
          type: string
          example: "10:00"
        scheduledEndTime:
          type: string
          example: "11:00"
        workLocation1:
          type: string
          example: "マツモトキヨシ"
        workLocation2:
          type: string
          example: "旭町1丁目"
        userId:
          type: string
          example: "uid_user_001"
        matchedSupporterId:
          type: string
          nullable: true

    # =====================================================
    #  利用者向け詳細 RequestDetailUser
    # =====================================================
    RequestDetailUser:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
        description:
          type: string
        status:
          type: string
        scheduledDate:
          type: string
        scheduledStartTime:
          type: string
        scheduledEndTime:
          type: string
        workLocation1:
          type: string
        workLocation2:
          type: string
        supporter:
          type: object
          nullable: true
          description: matchedSupporterId がある場合のみ表示
          properties:
            supporterName:
              type: string
              example: "サポーター太郎"
            supporterPhone:
              type: string
              example: "090-1234-5678"
            supporterNote:
              type: string
            supporterAvatarUrl:
              type: string
              nullable: true

    # =====================================================
    #  SupporterRequest（サポーター用一覧）
    # =====================================================
    SupporterRequest:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
        description:
          type: string
        status:
          type: string
          example: "open"
        scheduledDate:
          type: string
        scheduledStartTime:
          type: string
        scheduledEndTime:
          type: string
        user:
          $ref: "#/components/schemas/UserBrief"

    # =====================================================
    # UserBrief（サポーター用：open/他人依頼の簡易表示）
    # =====================================================
    UserBrief:
      type: object
      properties:
        gender:
          type: string
          example: "女性"
        address1:
          type: string
          example: "旭町1丁目"
        bio:
          type: string
        ageGroup:
          type: string
          example: "80代"

    # =====================================================
    # SupporterRequestDetail（サポーター向け詳細）
    # =====================================================
    SupporterRequestDetail:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
        description:
          type: string
        status:
          type: string
        scheduledDate:
          type: string
        scheduledStartTime:
          type: string
        scheduledEndTime:
          type: string
        user:
          oneOf:
            - $ref: "#/components/schemas/UserBrief"
            - $ref: "#/components/schemas/UserDetail"

    # =====================================================
    # UserDetail（サポーター自身が matched した場合の詳細）
    # =====================================================
    UserDetail:
      type: object
      properties:
        familyName:
          type: string
        firstName:
          type: string
        familyNameKana:
          type: string
        firstNameKana:
          type: string
        gender:
          type: string
        phoneNumber:
          type: string
        address1:
          type: string
        address2:
          type: string
        profileImageUrl:
          type: string
          nullable: true
        bio:
          type: string
        ageGroup:
          type: string
          example: "80代"

    # =====================================================
    # Order（共通）
    # =====================================================
    Order:
      type: object
      properties:
        requestId:
          type: integer
        supporterId:
          type: string
        status:
          type: string
          enum: [matched, confirmed, completed, canceled, decline, refusal]
          example: "matched"

    # =====================================================
    # SupporterOrderSummary（サポーター用受注一覧）
    # =====================================================
    SupporterOrderSummary:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
        status:
          type: string
        orderStatus:
          type: string
          example: "matched"
        user:
          $ref: "#/components/schemas/UserBrief"

    # =====================================================
    # SupporterOrderCreated（受注時の返却形式）
    # =====================================================
    SupporterOrderCreated:
      type: object
      properties:
        message:
          type: string
          example: "Order created successfully"
        order:
          $ref: "#/components/schemas/Order"
        updatedRequest:
          $ref: "#/components/schemas/Request"

    # =====================================================
    # ErrorResponse
    # =====================================================
    ErrorResponse:
      type: object
      properties:
        error:
          type: string