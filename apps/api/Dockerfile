
# âœ¨ Alpine ã§ã¯ãªã Debian(glibc) ã‚’ä½¿ã†
FROM node:24-bookworm-slim

WORKDIR /app
ENV PNPM_HOME="/pnpm" \
    PATH="$PNPM_HOME:$PATH" \
    PNPM_LOG_LEVEL=info

# pnpm ã‚’å›ºå®š
RUN corepack enable && corepack prepare pnpm@9.6.0 --activate

# ãƒã‚¤ãƒ†ã‚£ãƒ–ä¾å­˜ã®ãŸã‚ã« root è¨¼æ˜æ›¸ç­‰ã‚’ç”¨æ„
# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®ãŸã‚ã« 'curl' ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
RUN apt-get update -y \
  && apt-get install -y --no-install-recommends ca-certificates openssl curl \
  && rm -rf /var/lib/apt/lists/*

# 1) ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å®šç¾© + lockfile
COPY package.json pnpm-workspace.yaml tsconfig.base.json pnpm-lock.yaml ./
COPY apps/api/package.json apps/api/

# ----------------------------------------------------
# ğŸ’¡ prisma ã®å®Ÿä½“ã¯ apps/api/prisma é…ä¸‹
# postinstall ã§ prisma generate ãŒå®Ÿè¡Œã•ã‚Œã‚‹å ´åˆã«å‚™ãˆã€å…ˆã«ã‚³ãƒ”ãƒ¼
# ----------------------------------------------------
COPY apps/api/prisma/ apps/api/prisma/

# ã“ã“ã‹ã‚‰æ–°æ§‹æˆï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ“ãƒ«ãƒ‰ï¼šé–‹ç™ºæ™‚ç”¨ï¼‰
# ä¾å­˜ã‚’ lockfile ã«åŸºã¥ã„ã¦ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# ==============================
RUN pnpm install --frozen-lockfile

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆä¾å­˜è§£æ±ºå¾Œï¼‰
# ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€APIã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹ãŸã‚ã«ç¶­æŒã—ã¾ã™ã€‚
COPY apps/api apps/api

WORKDIR /app/apps/api
EXPOSE 3001

# ----------------------------------------------------
# ğŸŒŸ ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: HEALTHCHECK ã‚’è¿½åŠ 
# èµ·å‹•å¾Œ10ç§’å¾…æ©Ÿã—ã€5ç§’ã”ã¨ã« /healthz ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
# ----------------------------------------------------
HEALTHCHECK --interval=5s --timeout=3s --retries=3 \
  CMD curl -f http://localhost:3001/healthz || exit 1

CMD ["pnpm", "dev"]
